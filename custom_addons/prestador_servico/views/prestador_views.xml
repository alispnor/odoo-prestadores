<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_prestador_tree" model="ir.ui.view">
        <field name="name">prestador.servico.tree</field>
        <field name="model">prestador.servico</field>
        <field name="arch" type="xml">
            <tree string="Prestadores de Servi√ßo" 
                  default_order="name"
                  decoration-success="geocode_status == 'success'"
                  decoration-warning="geocode_status == 'pending'"
                  decoration-danger="geocode_status == 'failed'"
                  decoration-muted="geocode_status == 'incomplete'">
                <field name="name"/>
                <field name="categoria"/>
                <field name="celular"/>
                <field name="email"/>
                <field name="cidade"/>
                <field name="uf"/>
                <!-- Campos invis√≠veis para carregar os dados -->
                <field name="geocode_status" column_invisible="1"/>
                <field name="latitude" column_invisible="1"/>
                <field name="longitude" column_invisible="1"/>
                <!-- Campo visual para mostrar se tem coordenadas -->
                <field name="geocode_status" string="Localiza√ß√£o" 
                       widget="badge" 
                       decoration-success="geocode_status == 'success'"
                       decoration-warning="geocode_status == 'pending'"
                       decoration-danger="geocode_status == 'failed'"/>
                <field name="ativo" widget="boolean_toggle"/>
            </tree>
        </field>
    </record>

    <record id="view_prestador_form" model="ir.ui.view">
        <field name="name">prestador.servico.form</field>
        <field name="model">prestador.servico</field>
        <field name="arch" type="xml">
            <form string="Prestador de Servi√ßo">
                <header>
                    <!-- Bot√£o para for√ßar nova geocodifica√ß√£o -->
                    <button name="action_force_geocode" 
                            type="object" 
                            string="üó∫Ô∏è Atualizar Localiza√ß√£o" 
                            class="btn-secondary"
                            help="For√ßa uma nova busca de coordenadas"/>
                    <!-- Status badge no header -->
                    <field name="geocode_status" widget="statusbar" 
                           statusbar_visible="pending,success,failed,incomplete"/>
                </header>
                <sheet>
                    <group>
                        <group string="Dados Pessoais">
                            <field name="name"/>
                            <field name="cpf_cnpj"/>
                            <field name="categoria"/>
                            <field name="ativo" widget="boolean_toggle"/>
                        </group>
                        <group string="Contato">
                            <field name="celular"/>
                            <field name="email" widget="email"/>
                        </group>
                    </group>

                    <group string="Endere√ßo">
                        <group>
                            <field name="cep" placeholder="00000-000"/>
                            <field name="logradouro"/>
                            <field name="numero"/>
                            <field name="complemento"/>
                        </group>
                        <group>
                            <field name="bairro"/>
                            <field name="cidade"/>
                            <field name="uf" widget="selection"/>
                        </group>
                    </group>
                    
                    <!-- Se√ß√£o de localiza√ß√£o mais rica -->
                    <group string="üåê Localiza√ß√£o Geogr√°fica">
                        <group>
                            <field name="latitude" 
                                   readonly="1"
                                   decoration-success="latitude != 0"
                                   widget="float" 
                                   digits="[10,6]"/>
                            <field name="longitude" 
                                   readonly="1"
                                   decoration-success="longitude != 0"
                                   widget="float" 
                                   digits="[10,6]"/>
                        </group>
                        <group>
                            <field name="geocode_status" 
                                   readonly="1"
                                   widget="badge"
                                   decoration-success="geocode_status == 'success'"
                                   decoration-warning="geocode_status == 'pending'"
                                   decoration-danger="geocode_status == 'failed'"/>
                            <field name="last_geocode_attempt" 
                                   readonly="1"
                                   widget="datetime"/>
                        </group>
                    </group>

                    <!-- Se√ß√£o para mostrar coordenadas com estilo melhorado -->
                    <group string="üìç Localiza√ß√£o" 
                        invisible="latitude == 0" 
                        colspan="2">
                        <div class="o_field_widget" style="width: 100%; margin-bottom: 10px;">
                            <div  style="margin: 0; padding: 15px; border-radius: 8px; width: 100%; box-sizing: border-box;">
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: nowrap;">
                                        <strong style="color: #31708f; font-size: 14px; white-space: nowrap;">Coordenadas Geogr√°ficas:</strong>
                                        <span style="font-family: monospace; font-size: 13px; white-space: nowrap;">
                                            Lat: <field name="latitude" readonly="1" nolabel="1" class="oe_inline" style="font-weight: bold; color: #2c3e50;"/>
                                        </span>
                                        <span style="font-family: monospace; font-size: 13px; white-space: nowrap;">
                                            Lng: <field name="longitude" readonly="1" nolabel="1" class="oe_inline" style="font-weight: bold; color: #2c3e50;"/>
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fa fa-lightbulb-o" style="color: #31708f;"></i>
                                        <em style="color: #31708f; font-size: 12px; white-space: nowrap;">
                                            Copie as coordenadas e cole no Google Maps ou outro servi√ßo de mapas
                                        </em>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </group>


                </sheet>
                
                <!-- Chatter para hist√≥rico -->
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Search View para filtros -->
    <record id="view_prestador_search" model="ir.ui.view">
        <field name="name">prestador.servico.search</field>
        <field name="model">prestador.servico</field>
        <field name="arch" type="xml">
            <search string="Buscar Prestadores">
                <field name="name" string="Nome/CPF/CNPJ" 
                       filter_domain="['|', ('name','ilike',self), ('cpf_cnpj','ilike',self)]"/>
                <field name="categoria"/>
                <field name="cidade"/>
                <field name="uf"/>
                <field name="celular"/>
                <field name="email"/>
                
                <!-- Filtros pr√©-definidos -->
                <filter string="Ativos" name="ativo" domain="[('ativo','=',True)]"/>
                <filter string="Inativos" name="inativo" domain="[('ativo','=',False)]"/>
                
                <separator/>
                <filter string="Com Localiza√ß√£o" name="com_localizacao" 
                        domain="[('geocode_status','=','success')]"/>
                <filter string="Sem Localiza√ß√£o" name="sem_localizacao" 
                        domain="['|', ('geocode_status','!=','success'), ('latitude','=',0)]"/>
                <filter string="Geocodifica√ß√£o Pendente" name="geocode_pendente" 
                        domain="[('geocode_status','=','pending')]"/>
                <filter string="Erro na Geocodifica√ß√£o" name="geocode_erro" 
                        domain="[('geocode_status','=','failed')]"/>
                
                <!-- Agrupamentos -->
                <group expand="0" string="Agrupar Por">
                    <filter string="Categoria" name="group_categoria" context="{'group_by':'categoria'}"/>
                    <filter string="Estado" name="group_uf" context="{'group_by':'uf'}"/>
                    <filter string="Cidade" name="group_cidade" context="{'group_by':'cidade'}"/>
                    <filter string="Status Localiza√ß√£o" name="group_geocode" context="{'group_by':'geocode_status'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action principal -->
    <record id="action_prestador" model="ir.actions.act_window">
        <field name="name">Prestadores de Servi√ßo</field>
        <field name="res_model">prestador.servico</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_prestador_search"/>
        <field name="context">{}</field>
        <field name="target">current</field> 
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crie um novo prestador de servi√ßo para come√ßar a gerenciar sua rede.
            </p>
            <p>
                O sistema ir√° automaticamente buscar as coordenadas geogr√°ficas
                baseadas no endere√ßo informado.
            </p>
        </field>
    </record>

    <!-- Action para prestadores sem localiza√ß√£o -->
    <record id="action_prestador_sem_localizacao" model="ir.actions.act_window">
        <field name="name">Prestadores Sem Localiza√ß√£o</field>
        <field name="res_model">prestador.servico</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('geocode_status', '!=', 'success')]</field>
        <field name="context">{'search_default_sem_localizacao': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Todos os prestadores j√° possuem localiza√ß√£o!
            </p>
        </field>
    </record>

    <!-- Menus -->
    <menuitem id="menu_prestador_root"
              name="Prestadores de Servi√ßo"
              sequence="10"
              web_icon="prestador_servico,static/description/icon.png"/>
              
    <menuitem id="menu_prestador_management"
              name="Todos os Prestadores"
              parent="menu_prestador_root"
              action="action_prestador"
              sequence="10"/>
              
    <menuitem id="menu_prestador_sem_localizacao"
              name="Sem Localiza√ß√£o"
              parent="menu_prestador_root"
              action="action_prestador_sem_localizacao"
              sequence="20"/>

</odoo>
